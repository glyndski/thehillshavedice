<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Booking - The Hills Have Dice</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script type="module" src="https://unpkg.com/@material/web@1.0.0/all.js?module"></script>

    <link rel="stylesheet" href="styles.css">

    <link rel="icon" type="image/png" href="thhd_favicon.jpg">
    <link rel="apple-touch-icon" href="thhd_favicon.jpg">

    <meta name="theme-color" content="#556b2f">
    <meta property="og:title" content="The Hills Have Dice - Game Booking">
    <meta property="og:description" content="Sign up for tabletop games, wargaming, and board games at our next club meet!">
    <meta property="og:image" content="https://glyndski.github.io/thehillshavedice/thhd_logo.png"> 
    <meta property="og:url" content="https://glyndski.github.io/thehillshavedice/">
    <meta property="og:type" content="website">
    
</head>
<body>

    <img src="thhd_logo.png" alt="The Hills Have Dice Club Logo" class="club-logo">
    
    <div style="position: absolute; top: 10px; right: 10px;">
        <md-text-button onclick="resetName()">Change ID</md-text-button>
    </div>

    <h1>The Hills Have Dice</h1>
    
    <h2 id="dynamic-event-header">Loading Event Info...</h2>
    <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 2rem; flex-wrap: wrap;">
        
        <md-outlined-button href="https://www.facebook.com/groups/581368555001852/" target="_blank">
            <svg slot="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.15 5.96C15.21 5.96 16.12 6.04 16.12 6.04V8.51H15.01C13.77 8.51 13.38 9.28 13.38 10.07V12.06H16.15L15.71 14.96H13.38V21.96C18.16 21.21 21.82 17.06 21.82 12.06C21.82 6.53 17.32 2.04 12 2.04Z"/>
            </svg>
            Facebook Group
        </md-outlined-button>
        
        <md-outlined-button href="https://discord.gg/HNz7tj7VV7" target="_blank">
            <svg slot="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4.09C14.85 4.36 14.65 4.73 14.5 5.09C12.92 4.85 11.34 4.85 9.77 5.09C9.61 4.74 9.4 4.37 9.25 4.09C7.76 4.26 6.31 4.71 4.97 5.33C2.31 9.29 1.58 13.15 1.94 16.94C3.72 18.25 5.45 19.04 7.14 19.04C7.56 18.47 7.93 17.86 8.24 17.22C7.62 16.98 7.03 16.69 6.47 16.35C6.63 16.23 6.78 16.11 6.93 15.98C10.23 17.5 13.79 17.5 17.05 15.98C17.2 16.11 17.36 16.23 17.51 16.35C16.96 16.69 16.37 16.98 15.74 17.22C16.05 17.86 16.42 18.47 16.84 19.04C18.53 19.04 20.26 18.25 22.04 16.94C22.46 12.63 21.41 8.85 19.27 5.33ZM8.55 13.78C7.56 13.78 6.74 12.87 6.74 11.76C6.74 10.65 7.54 9.74 8.55 9.74C9.57 9.74 10.39 10.65 10.37 11.76C10.37 12.87 9.57 13.78 8.55 13.78ZM15.43 13.78C14.43 13.78 13.61 12.87 13.61 11.76C13.61 10.65 14.41 9.74 15.43 9.74C16.45 9.74 17.27 10.65 17.25 11.76C17.25 12.87 16.45 13.78 15.43 13.78Z"/>
            </svg>
            Discord
        </md-outlined-button>
    </div>

    <div class="input-container">
        <div class="input-row">
            <md-filled-text-field id="hostName" label="Host Name" class="input-host"></md-filled-text-field>
            <md-filled-text-field id="gameName" label="Game / System" class="input-game"></md-filled-text-field>
            
            <md-filled-text-field id="gameTime" label="Time" placeholder="18:30" class="input-time"></md-filled-text-field>
            
            <md-filled-text-field id="maxPlayers" label="Max" type="number" class="input-max"></md-filled-text-field>
            
            <md-filled-button id="postGameBtn" class="input-btn">
                <md-icon slot="icon">add_circle</md-icon>
                Post
            </md-filled-button>
        </div>
        
        <div class="toggle-row">
            <md-switch id="beginnerToggle"></md-switch>
            <label for="beginnerToggle">Beginner Friendly / Teaching Game</label>
        </div>
    </div>

    <div id="gamesList"></div>

    <md-fab id="postGameFab" label="New Game" extended="true" icon="edit"></md-fab>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAjRxDf55tgjwGlW8vPWPeX5pmo80IdQIo",
            authDomain: "the-hills-have-dice-67561.firebaseapp.com",
            databaseURL: "https://the-hills-have-dice-67561-default-rtdb.firebaseio.com",
            projectId: "the-hills-have-dice-67561",
            storageBucket: "the-hills-have-dice-67561.firebasestorage.app",
            messagingSenderId: "504957236565",
            appId: "1:504957236565:web:9df153cbd6d0c5633cabdc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let games = {};

        const headerElement = document.getElementById('dynamic-event-header');
        db.ref('eventDetails/message').on('value', snapshot => {
            if (snapshot.exists()) {
                headerElement.innerText = snapshot.val();
            } else {
                headerElement.innerText = "Upcoming Event TBD";
            }
        });

        function getUserName() {
            let name = localStorage.getItem('thhd_username');
            if (!name) {
                name = prompt("Please enter your name (this will be saved):");
                if (name && name.trim() !== "") {
                    localStorage.setItem('thhd_username', name.trim());
                    const hostInput = document.getElementById('hostName');
                    if (hostInput && !hostInput.value) hostInput.value = name.trim();
                }
            }
            return name;
        }

        function resetName() {
            localStorage.removeItem('thhd_username');
            document.getElementById('hostName').value = "";
            alert("Name cleared! Next action will ask for your name.");
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('thhd_username');
            if (savedName) document.getElementById('hostName').value = savedName;
        });

        // --- COMMENT LOGIC REMAINS SAME ---
        function updateCommentCount(key) {
            const countRef = db.ref(`games/${key}/comments`);
            const badgeElement = document.getElementById(`comment-count-${key}`);
            countRef.on('value', snapshot => {
                const comments = snapshot.val();
                const count = comments ? Object.keys(comments).length : 0;
                if (badgeElement) {
                    badgeElement.textContent = count;
                    badgeElement.style.display = count > 0 ? 'inline-block' : 'none';
                }
                const container = document.getElementById(`comment-container-${key}`);
                if(container) {
                   const icon = container.querySelector('md-icon');
                   const section = document.getElementById(`comments-${key}`);
                   if (section.style.display !== 'block') {
                       icon.textContent = count > 0 ? 'chat_bubble' : 'chat_bubble_outline';
                   }
                }
            });
        }

        function toggleComments(key) {
            const commentsSection = document.getElementById(`comments-${key}`);
            const container = document.getElementById(`comment-container-${key}`);
            const button = container.querySelector('md-icon-button');
            const isHidden = commentsSection.style.display === 'none';
            commentsSection.style.display = isHidden ? 'block' : 'none';
            const icon = button.querySelector('md-icon');
            icon.textContent = isHidden ? 'chat_bubble' : 'chat_bubble_outline'; 
            if (isHidden) loadComments(key);
            else updateCommentCount(key);
        }
        
        function postComment(key) {
             const inputField = document.getElementById(`comment-input-${key}`);
             const comment = inputField.value.trim();
             const userName = getUserName();
             if (!comment || !userName) return;
             db.ref('games/' + key + '/comments').push({ 
                 user: userName, text: comment, timestamp: Date.now() 
             }).then(() => { inputField.value = ''; })
             .catch(error => alert("Error: " + error.message));
        }
        
        function loadComments(key) {
            const commentsListDiv = document.getElementById(`comments-list-${key}`);
            db.ref('games/' + key + '/comments').once('value').then(snapshot => {
                const comments = snapshot.val();
                commentsListDiv.innerHTML = "";
                if (!comments) {
                    commentsListDiv.innerHTML = '<p style="color: #999; margin: 0;">No comments yet.</p>';
                    return;
                }
                const sortedComments = Object.values(comments).sort((a, b) => a.timestamp - b.timestamp);
                sortedComments.forEach(c => {
                    const date = new Date(c.timestamp).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const div = document.createElement('div');
                    div.className = 'comment-entry';
                    div.innerHTML = `<strong>${c.user}</strong> <span style="color:#888;font-size:0.8em">(${date})</span><p style="margin:2px 0 0 0;">${c.text}</p>`;
                    commentsListDiv.appendChild(div);
                });
                commentsListDiv.scrollTop = commentsListDiv.scrollHeight;
            }); 
        }

        // --- UPDATED GAME LOGIC (Includes Time + Beginner Tag) ---
        function addGame() {
            const hostInput = document.getElementById('hostName');
            const host = hostInput.value.trim();
            const name = document.getElementById('gameName').value.trim();
            const time = document.getElementById('gameTime').value.trim(); // NEW
            const isBeginner = document.getElementById('beginnerToggle').selected; // NEW
            const max = parseInt(document.getElementById('maxPlayers').value);

            if (!host || !name || isNaN(max) || max <= 0) {
                alert("Please fill in Host, Game Name, and Max Players.");
                return;
            }
            localStorage.setItem('thhd_username', host);

            const newGameRef = db.ref('games').push();
            // Save new fields
            newGameRef.set({ name, max, host, time, isBeginner, players: {} })
                .then(() => {
                    const gameKey = newGameRef.key;
                    db.ref('games/' + gameKey + '/players').push(host)
                        .then(() => {
                            document.getElementById('gameName').value = "";
                            document.getElementById('maxPlayers').value = "";
                            document.getElementById('gameTime').value = "";
                            document.getElementById('beginnerToggle').selected = false;
                            alert("Game Posted!");
                        });
                })
                .catch(error => alert("Error: " + error.message));
        }
        
        function joinGame(key) {
            const player = getUserName();
            if (!player) return;
            db.ref('games/' + key).once('value').then(snapshot => {
                const game = snapshot.val();
                const players = game.players ? Object.values(game.players) : [];
                if (players.includes(player)) {
                    alert("You're already signed up!");
                    return;
                }
                if (players.length < game.max) {
                    db.ref('games/' + key + '/players').push(player);
                } else {
                    alert("Game is full!");
                }
            });
        }

        function leaveGame(key) {
            const player = getUserName();
            if (!player) return;
            db.ref('games/' + key).once('value').then(snapshot => {
                const game = snapshot.val();
                if (player.toLowerCase() === game.host.toLowerCase()) {
                     alert("Hosts cannot leave. Please contact Admin to delete.");
                     return;
                }
                const playersRef = db.ref('games/' + key + '/players');
                playersRef.orderByValue().equalTo(player).once('value').then(playerSnapshot => {
                    if (!playerSnapshot.exists()) {
                        alert("You are not signed up.");
                        return;
                    }
                    playerSnapshot.forEach(childSnap => { childSnap.ref.remove(); });
                });
            });
        }
        
        function deleteGame() {
            alert("For security, games can only be deleted by an Admin. Contact the club organizer.");
        }

        const gamesList = document.getElementById('gamesList');
        
        db.ref('games').on('value', snapshot => {
            const openSections = new Set();
            document.querySelectorAll('.comments-section').forEach(section => {
                if (section.style.display === 'block') {
                    openSections.add(section.id.replace('comments-', ''));
                }
            });

            games = snapshot.val() || {};
            gamesList.innerHTML = "";

            for (let key in games) {
                const g = games[key];
                const players = g.players ? Object.values(g.players) : [];
                const progress = players.length / g.max;
                const isFull = progress >= 1;
                
                let statusColor = isFull ? "#ba1a1a" : (progress >= 0.7 ? "#d58d00" : "#556b2f");
                let statusIcon = isFull ? "lock" : "groups";
                let statusText = isFull ? "FULL" : `${players.length}/${g.max}`;

                // Build Tag HTML
                let tagsHTML = "";
                if (g.time) tagsHTML += `<span class="badge-time">${g.time}</span> `;
                if (g.isBeginner) tagsHTML += `<span class="badge-beginner">Beginner Friendly</span>`;

                let playerChipsHTML = players.length > 0 
                    ? players.map(p => `<md-assist-chip label="${p}" style="pointer-events:none"></md-assist-chip>`).join(" ")
                    : '<span style="color:#777; font-size:0.9rem; font-style:italic;">Be the first to join!</span>';

                const card = document.createElement('md-elevated-card');
                card.style.setProperty('--md-linear-progress-active-indicator-color', statusColor);
                card.style.setProperty('--md-linear-progress-track-color', statusColor);

                card.innerHTML = `
                    <div class="card-content">
                        <div class="card-header">
                            <div>
                                <div class="game-title">${g.name}</div>
                                <div class="host-line">
                                    Hosted by ${g.host}
                                    ${tagsHTML}
                                </div>
                            </div>
                            
                            <div id="comment-container-${key}" style="position: relative;"> 
                                <md-icon-button onclick="toggleComments('${key}')">
                                    <md-icon>chat_bubble_outline</md-icon>
                                </md-icon-button>
                                <span id="comment-count-${key}" class="comment-badge" style="display: none;">0</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; color:${statusColor}">
                            <md-icon style="font-size: 18px;">${statusIcon}</md-icon>
                            <div style="font-weight: 700; font-size: 0.9rem;">${statusText}</div>
                        </div>
                        <md-linear-progress value="${progress}" buffer="1"></md-linear-progress>

                        <div class="chip-container">
                            ${playerChipsHTML}
                        </div>

                        <div class="card-actions">
                            <md-outlined-button class="btn-delete" onclick="deleteGame()">Delete</md-outlined-button>
                            <md-outlined-button onclick="leaveGame('${key}')">Leave</md-outlined-button>
                            <md-filled-tonal-button onclick="joinGame('${key}')">Join</md-filled-tonal-button>
                        </div>
                        
                        <div id="comments-${key}" class="comments-section" style="display: none;">
                            <h3 style="font-size: 0.9rem; margin-top: 0; margin-bottom: 8px;">Discussion</h3>
                            <div id="comments-list-${key}" style="max-height: 150px; overflow-y: auto; margin-bottom: 12px;">
                                <p style="color: #999;">Loading...</p>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <md-filled-text-field id="comment-input-${key}" label="Comment" style="flex:1"></md-filled-text-field>
                                <md-icon-button onclick="postComment('${key}')">
                                    <md-icon>send</md-icon>
                                </md-icon-button>
                            </div>
                        </div>
                    </div>
                `;
                gamesList.appendChild(card);
                
                if (openSections.has(key)) {
                    const section = document.getElementById(`comments-${key}`);
                    if(section) {
                        section.style.display = 'block';
                        card.querySelector(`#comment-container-${key} md-icon`).textContent = 'chat_bubble';
                        loadComments(key);
                    }
                }
                updateCommentCount(key);
            }
        });

        document.getElementById('postGameBtn').addEventListener('click', addGame);
        document.getElementById('postGameFab').addEventListener('click', () => {
             window.scrollTo({ top: 0, behavior: 'smooth' });
             document.getElementById('hostName').focus();
        });
    </script>
</body>
</html>




