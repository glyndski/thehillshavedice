<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Booking - The Hills Have Dice</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script type="module" src="https://unpkg.com/@material/web@1.0.0/all.js?module"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <img src="thhd_logo.png" alt="The Hills Have Dice Club Logo" class="club-logo">
    
    <div style="position: absolute; top: 10px; right: 10px;">
        <md-text-button onclick="resetName()">Change ID</md-text-button>
    </div>

    <h1>The Hills Have Dice</h1>
    
    <h2 id="dynamic-event-header">Loading Event Info...</h2>

    <div class="input-container">
        <div class="input-row">
            <md-filled-text-field id="hostName" label="Host Name" maxlength="30"></md-filled-text-field>
            <md-filled-text-field id="gameName" label="Game / System" maxlength="50"></md-filled-text-field>
            <md-filled-text-field id="maxPlayers" label="Max" type="number"></md-filled-text-field>
            <md-filled-button id="postGameBtn">
                <md-icon slot="icon">add_circle</md-icon>
                Post
            </md-filled-button>
        </div>
    </div>

    <div id="gamesList"></div>

    <md-fab id="postGameFab" label="New Game" extended="true" icon="edit"></md-fab>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyAjRxDf55tgjwGlW8vPWPeX5pmo80IdQIo",
            authDomain: "the-hills-have-dice-67561.firebaseapp.com",
            databaseURL: "https://the-hills-have-dice-67561-default-rtdb.firebaseio.com",
            projectId: "the-hills-have-dice-67561",
            storageBucket: "the-hills-have-dice-67561.firebasestorage.app",
            messagingSenderId: "504957236565",
            appId: "1:504957236565:web:9df153cbd6d0c5633cabdc"
        };

        // 2. INITIALIZE
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let games = {};

        // 3. EVENT HEADER LISTENER
        const headerElement = document.getElementById('dynamic-event-header');
        db.ref('eventDetails/message').on('value', snapshot => {
            if (snapshot.exists()) {
                headerElement.innerText = snapshot.val();
            } else {
                headerElement.innerText = "Upcoming Event TBD";
            }
        });

        // 4. USER IDENTITY
        function getUserName() {
            let name = localStorage.getItem('thhd_username');
            if (!name) {
                name = prompt("Please enter your name (this will be saved):");
                if (name && name.trim() !== "") {
                    localStorage.setItem('thhd_username', name.trim());
                    const hostInput = document.getElementById('hostName');
                    if (hostInput && !hostInput.value) hostInput.value = name.trim();
                }
            }
            return name;
        }

        function resetName() {
            localStorage.removeItem('thhd_username');
            document.getElementById('hostName').value = "";
            alert("Name cleared! Next action will ask for your name.");
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('thhd_username');
            if (savedName) document.getElementById('hostName').value = savedName;
        });

        // 5. COMMENT LOGIC
        function updateCommentCount(key) {
            const countRef = db.ref(`games/${key}/comments`);
            const badgeElement = document.getElementById(`comment-count-${key}`);
            
            countRef.on('value', snapshot => {
                const comments = snapshot.val();
                const count = comments ? Object.keys(comments).length : 0;
                
                if (badgeElement) {
                    badgeElement.textContent = count;
                    badgeElement.style.display = count > 0 ? 'inline-block' : 'none';
                }
                // Update button icon if needed
                const container = document.getElementById(`comment-container-${key}`);
                if(container) {
                   const icon = container.querySelector('md-icon');
                   const section = document.getElementById(`comments-${key}`);
                   if (section.style.display !== 'block') {
                       icon.textContent = count > 0 ? 'chat_bubble' : 'chat_bubble_outline';
                   }
                }
            });
        }

        function toggleComments(key) {
            const commentsSection = document.getElementById(`comments-${key}`);
            const container = document.getElementById(`comment-container-${key}`);
            const button = container.querySelector('md-icon-button');
            
            const isHidden = commentsSection.style.display === 'none';
            commentsSection.style.display = isHidden ? 'block' : 'none';
            
            const icon = button.querySelector('md-icon');
            icon.textContent = isHidden ? 'chat_bubble' : 'chat_bubble_outline'; 
            
            if (isHidden) {
                loadComments(key);
            } else {
                updateCommentCount(key); // Reset icon based on count
            }
        }
        
        function postComment(key) {
             const inputField = document.getElementById(`comment-input-${key}`);
             const comment = inputField.value.trim();
             const userName = getUserName();
             
             if (!comment || !userName) return;

             db.ref('games/' + key + '/comments').push({ 
                 user: userName, 
                 text: comment, 
                 timestamp: Date.now() 
             })
             .then(() => { inputField.value = ''; })
             .catch(error => alert("Error: " + error.message));
        }
        
        function loadComments(key) {
            const commentsListDiv = document.getElementById(`comments-list-${key}`);
            
            db.ref('games/' + key + '/comments').once('value').then(snapshot => {
                const comments = snapshot.val();
                commentsListDiv.innerHTML = "";
                
                if (!comments) {
                    commentsListDiv.innerHTML = '<p style="color: #999; margin: 0;">No comments yet.</p>';
                    return;
                }
                const sortedComments = Object.values(comments).sort((a, b) => a.timestamp - b.timestamp);
                sortedComments.forEach(c => {
                    const date = new Date(c.timestamp).toLocaleString([], { 
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                    });
                    const div = document.createElement('div');
                    div.className = 'comment-entry';
                    div.innerHTML = `<strong>${c.user}</strong> <span style="color:#888;font-size:0.8em">(${date})</span><p style="margin:2px 0 0 0;">${c.text}</p>`;
                    commentsListDiv.appendChild(div);
                });
                commentsListDiv.scrollTop = commentsListDiv.scrollHeight;
            }); 
        }

        // 6. GAME LOGIC
        function addGame() {
            const hostInput = document.getElementById('hostName');
            const host = hostInput.value.trim();
            const name = document.getElementById('gameName').value.trim();
            const max = parseInt(document.getElementById('maxPlayers').value);

            if (!host || !name || isNaN(max) || max <= 0) {
                alert("Please fill in ALL fields!");
                return;
            }
            localStorage.setItem('thhd_username', host);

            const newGameRef = db.ref('games').push();
            newGameRef.set({ name, max, host, players: {} })
                .then(() => {
                    const gameKey = newGameRef.key;
                    db.ref('games/' + gameKey + '/players').push(host)
                        .then(() => {
                            document.getElementById('gameName').value = "";
                            document.getElementById('maxPlayers').value = "";
                            alert("Game Posted!");
                        });
                })
                .catch(error => alert("Error: " + error.message));
        }
        
        function joinGame(key) {
            const player = getUserName();
            if (!player) return;

            db.ref('games/' + key).once('value').then(snapshot => {
                const game = snapshot.val();
                const players = game.players ? Object.values(game.players) : [];

                if (players.includes(player)) {
                    alert("You're already signed up!");
                    return;
                }
                if (players.length < game.max) {
                    db.ref('games/' + key + '/players').push(player);
                } else {
                    alert("Game is full!");
                }
            });
        }

        function leaveGame(key) {
            const player = getUserName();
            if (!player) return;

            db.ref('games/' + key).once('value').then(snapshot => {
                const game = snapshot.val();
                if (player.toLowerCase() === game.host.toLowerCase()) {
                     alert("Hosts cannot leave. Please contact Admin to delete.");
                     return;
                }
                const playersRef = db.ref('games/' + key + '/players');
                playersRef.orderByValue().equalTo(player).once('value').then(playerSnapshot => {
                    if (!playerSnapshot.exists()) {
                        alert("You are not signed up.");
                        return;
                    }
                    playerSnapshot.forEach(childSnap => {
                        childSnap.ref.remove();
                    });
                });
            });
        }
        
        function deleteGame() {
            alert("For security, games can only be deleted by an Admin. Contact the club organizer.");
        }

        // 7. REALTIME RENDERER (The New Design)
        const gamesList = document.getElementById('gamesList');
        
        db.ref('games').on('value', snapshot => {
            // Keep track of open comments sections
            const openSections = new Set();
            document.querySelectorAll('.comments-section').forEach(section => {
                if (section.style.display === 'block') {
                    openSections.add(section.id.replace('comments-', ''));
                }
            });

            games = snapshot.val() || {};
            gamesList.innerHTML = "";

            for (let key in games) {
                const g = games[key];
                const players = g.players ? Object.values(g.players) : [];
                const progress = players.length / g.max;
                const isFull = progress >= 1;
                
                // Logic for colors
                let statusColor = isFull ? "#ba1a1a" : (progress >= 0.7 ? "#d58d00" : "#556b2f");
                let statusIcon = isFull ? "lock" : "groups";
                let statusText = isFull ? "FULL" : `${players.length}/${g.max}`;

                // Generate Player Chips
                let playerChipsHTML = players.length > 0 
                    ? players.map(p => `<md-assist-chip label="${p}" style="pointer-events:none"></md-assist-chip>`).join(" ")
                    : '<span style="color:#777; font-size:0.9rem; font-style:italic;">Be the first to join!</span>';

                const card = document.createElement('md-elevated-card');
                // Set progress bar color dynamically
                card.style.setProperty('--md-linear-progress-active-indicator-color', statusColor);
                card.style.setProperty('--md-linear-progress-track-color', statusColor);

                card.innerHTML = `
                    <div class="card-content">
                        
                        <div class="card-header">
                            <div>
                                <div class="host-name">Host: ${g.host}</div>
                                <div class="game-title">${g.name}</div>
                            </div>
                            
                            <div id="comment-container-${key}" style="position: relative;"> 
                                <md-icon-button onclick="toggleComments('${key}')">
                                    <md-icon>chat_bubble_outline</md-icon>
                                </md-icon-button>
                                <span id="comment-count-${key}" class="comment-badge" style="display: none;">0</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; color:${statusColor}">
                            <md-icon style="font-size: 18px;">${statusIcon}</md-icon>
                            <div style="font-weight: 700; font-size: 0.9rem;">${statusText}</div>
                        </div>
                        <md-linear-progress value="${progress}" buffer="1"></md-linear-progress>

                        <div class="chip-container">
                            ${playerChipsHTML}
                        </div>

                        <div class="card-actions">
                            <md-outlined-button class="btn-delete" onclick="deleteGame()">Delete</md-outlined-button>
                            <md-outlined-button onclick="leaveGame('${key}')">Leave</md-outlined-button>
                            <md-filled-tonal-button onclick="joinGame('${key}')">Join</md-filled-tonal-button>
                        </div>
                        
                        <div id="comments-${key}" class="comments-section" style="display: none;">
                            <h3 style="font-size: 0.9rem; margin-top: 0; margin-bottom: 8px;">Discussion</h3>
                            <div id="comments-list-${key}" style="max-height: 150px; overflow-y: auto; margin-bottom: 12px;">
                                <p style="color: #999;">Loading...</p>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <md-filled-text-field id="comment-input-${key}" label="Comment" style="flex:1"></md-filled-text-field>
                                <md-icon-button onclick="postComment('${key}')">
                                    <md-icon>send</md-icon>
                                </md-icon-button>
                            </div>
                        </div>
                    </div>
                `;
                gamesList.appendChild(card);
                
                // Restore open windows
                if (openSections.has(key)) {
                    const section = document.getElementById(`comments-${key}`);
                    if(section) {
                        section.style.display = 'block';
                        card.querySelector(`#comment-container-${key} md-icon`).textContent = 'chat_bubble';
                        loadComments(key);
                    }
                }
                updateCommentCount(key);
            }
        });

        document.getElementById('postGameBtn').addEventListener('click', addGame);
        document.getElementById('postGameFab').addEventListener('click', () => {
             window.scrollTo({ top: 0, behavior: 'smooth' });
             document.getElementById('hostName').focus();
        });
    </script>
</body>
</html>
